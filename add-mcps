#!/bin/bash

# add-mcps.sh - Install MCP servers at project level for Claude Code
# Usage: ./add-mcps.sh [--disable server1,server2] [--only server1,server2] [--diagnose] [--force] [--add-agents] [--add-tools] [--uninstall] [-h|--help]
# Version: 2.5 - Added --uninstall option for full cleanup

set -e

# Add local bin to PATH for uvx and ensure API key is available
export PATH="$HOME/.local/bin:$PATH"
export EXA_API_KEY="${EXA_API_KEY:-2ea2c6f8-2fb7-4ff7-bb2d-16a7356bd248}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Define all available MCP servers
declare MCP_SERVERS=(
    ["exa"]="exa"
    ["sequential-thinking"]="sequential-thinking"
    ["serena"]="serena"
    ["playwright"]="playwright"
    ["context7"]="context7"
    ["server-memory"]="server-memory"
)

# Parse command line arguments
DISABLE_SERVERS=""
ONLY_SERVERS=""
DIAGNOSE_MODE=false
FORCE_REINSTALL=false
ADD_AGENTS=false
ADD_TOOLS=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --disable)
            DISABLE_SERVERS="$2"
            shift 2
            ;;
        --only)
            ONLY_SERVERS="$2"
            shift 2
            ;;
        --diagnose)
            DIAGNOSE_MODE=true
            shift
            ;;
        --force)
            FORCE_REINSTALL=true
            shift
            ;;
        --add-agents)
            ADD_AGENTS=true
            shift
            ;;
        --add-tools)
            ADD_TOOLS=true
            shift
            ;;
        -h|--help)
            echo "Usage: $0 [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  -h, --help                           # Show this help message"
            echo "  --disable server1,server2            # Disable specific servers"
            echo "  --only server1,server2               # Install only specific servers"
            echo "  --diagnose                           # Run diagnostics and fix common issues"
            echo "  --force                              # Force reinstallation of all servers"
            echo "  --add-agents                         # Copy agents and AGENTS.md to project"
            echo "  --add-tools                          # Copy TOOL_USAGE.md to project docs/"
            echo ""
            echo "Available servers:"
            echo "  - exa: Web search and research capabilities"
            echo "  - sequential-thinking: Step-by-step problem solving"
            echo "  - serena: Semantic code retrieval and editing"
            echo "  - playwright: Browser automation"
            echo "  - context7: Up-to-date code documentation"
            echo "  - server-memory: Persistent memory and knowledge management"
            echo ""
            echo "Examples:"
            echo "  $0                                   # Install all servers (skip docs/agents by default)"
            echo "  $0 --add-agents --add-tools         # Install servers + copy docs and agents"
            echo "  $0 --only exa,context7              # Install only exa and context7"
            echo "  $0 --disable serena,playwright      # Install all except serena and playwright"
            echo "  $0 --diagnose                       # Check and fix system issues"
            echo "  $0 --force                          # Force reinstall all servers"
            echo "  $0 --force --add-tools              # Force reinstall + add TOOL_USAGE.md"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# Get add-mcps installation directory
# This should be ~/.add-mcps/ after running install.sh
ADD_MCPS_DIR="$HOME/.add-mcps"

# Check if installation directory exists (unless --help was used)
if [[ ! -d "$ADD_MCPS_DIR" ]]; then
    log_error "add-mcps installation not found at $ADD_MCPS_DIR"
    log_error "Please run install.sh first to set up the system"
    exit 1
fi

# Function to check if a server should be installed
should_install_server() {
    local server="$1"
    
    # If --only is specified, only install servers in that list
    if [[ -n "$ONLY_SERVERS" ]]; then
        if [[ ",$ONLY_SERVERS," == *",$server,"* ]]; then
            return 0
        else
            return 1
        fi
    fi
    
    # If --disable is specified, don't install servers in that list
    if [[ -n "$DISABLE_SERVERS" ]]; then
        if [[ ",$DISABLE_SERVERS," == *",$server,"* ]]; then
            return 1
        else
            return 0
        fi
    fi
    
    # Default: install the server
    return 0
}

# System diagnostics and fixes
diagnose_and_fix() {
    log_info "Running system diagnostics..."
    
    # Check Node.js
    if ! command -v node &> /dev/null; then
        log_error "Node.js is not installed. Please install Node.js first."
        exit 1
    fi
    log_success "Node.js found: $(node --version)"
    
    # Check NPM
    if ! command -v npm &> /dev/null; then
        log_error "npm is not installed. Please install npm first."
        exit 1
    fi
    log_success "npm found: $(npm --version)"
    
    # Check NPX and fix if broken
    if ! npx --version &> /dev/null; then
        log_warning "npx is broken or missing. Attempting to fix..."
        
        # Remove broken npx if it exists
        if [[ -f "/usr/local/bin/npx" ]] && ! /usr/local/bin/npx --version &> /dev/null; then
            log_info "Removing broken npx installation..."
            sudo rm -f /usr/local/bin/npx
        fi
        
        # Reinstall npm if necessary
        if ! npx --version &> /dev/null; then
            log_info "Reinstalling npm to fix npx..."
            sudo npm install -g npm@latest
        fi
        
        # Final check
        if npx --version &> /dev/null; then
            log_success "npx fixed: $(npx --version)"
        else
            log_error "Failed to fix npx. Please reinstall Node.js/npm."
            exit 1
        fi
    else
        log_success "npx found: $(npx --version)"
    fi
    
    # Test network connectivity
    if curl -s --connect-timeout 5 https://registry.npmjs.org/ > /dev/null; then
        log_success "Network connectivity to npm registry: OK"
    else
        log_warning "Network connectivity to npm registry: FAILED"
        log_warning "MCP servers may fail to install due to network issues"
    fi
    
    # Check Playwright dependencies
    log_info "Checking Playwright system dependencies..."
    if command -v npx &> /dev/null; then
        log_info "Installing/updating Playwright dependencies..."
        npx playwright install-deps > /dev/null 2>&1 || log_warning "Some Playwright dependencies may be missing"
        npx playwright install > /dev/null 2>&1 || log_warning "Playwright browsers may not be fully installed"
        log_success "Playwright dependencies checked"
    fi
    
    # Test Exa API key
    local exa_key="${EXA_API_KEY:-2ea2c6f8-2fb7-4ff7-bb2d-16a7356bd248}"
    if curl -s -H "Authorization: Bearer $exa_key" "https://api.exa.ai/search" -H "Content-Type: application/json" -d '{"query": "test", "numResults": 1}' | grep -q '"results"'; then
        log_success "Exa API key validation: OK"
    else
        log_warning "Exa API key validation: FAILED (server may still work)"
    fi
    
    log_success "System diagnostics completed!"
    echo ""
}

# Get current project directory
PROJECT_DIR="$(pwd)"
log_info "Installing MCP servers for project: $PROJECT_DIR"
echo ""

# Run diagnostics if requested or auto-diagnose on first run
if [[ "$DIAGNOSE_MODE" == true ]]; then
    diagnose_and_fix
    if [[ -z "$ONLY_SERVERS" ]] && [[ -z "$DISABLE_SERVERS" ]]; then
        log_info "Diagnostics complete. Run without --diagnose to install servers."
        exit 0
    fi
else
    # Quick diagnostics on every run
    if ! npx --version &> /dev/null; then
        log_warning "npx issues detected. Running auto-diagnostics..."
        diagnose_and_fix
    fi
fi

# Create .claude directory if it doesn't exist
mkdir -p "$PROJECT_DIR/.claude"

# Check if settings.local.json exists, if not create it
SETTINGS_FILE="$PROJECT_DIR/.claude/settings.local.json"
if [[ ! -f "$SETTINGS_FILE" ]]; then
    echo '{"mcpServers": {}}' > "$SETTINGS_FILE"
    echo "Created $SETTINGS_FILE"
fi

# Function to add MCP server using Claude CLI
add_mcp_server() {
    local name="$1"
    local command="$2"

    # Check if server is already installed
    if /Users/pentester/.claude/local/claude mcp list 2>/dev/null | grep -q "^$name:"; then
        if [[ "$FORCE_REINSTALL" == true ]]; then
            log_info "$name is already installed, removing for reinstallation..."
            if /Users/pentester/.claude/local/claude mcp remove "$name" 2>/dev/null; then
                log_success "Successfully removed $name"
            else
                log_warning "Failed to remove $name, attempting to install anyway..."
            fi
        else
            log_info "$name is already installed, skipping..."
            return 0
        fi
    fi

    log_info "Adding $name..."
    if eval "$command"; then
        log_success "Successfully added $name"
    else
        log_error "Failed to add $name"
        return 1
    fi
}

# Function to check if TOOL_USAGE.md content already exists in target file
tool_usage_content_exists() {
    local target_file="$1"

    if [[ ! -f "$target_file" ]]; then
        return 1  # File doesn't exist, content not present
    fi

    # Check if the file contains a marker that indicates our content was added
    # We'll use the first unique line from TOOL_USAGE.md as a marker
    if grep -q "## ðŸ” OPTIMAL TOOL USAGE - BUILT-IN TOOLS, GLOB, GREP & SERENA MCP" "$target_file" 2>/dev/null; then
        return 0  # Content already exists
    fi

    return 1  # Content doesn't exist
}

# Function to check if AGENTS.md content already exists in target file
agents_content_exists() {
    local target_file="$1"
    
    if [[ ! -f "$target_file" ]]; then
        return 1  # File doesn't exist, content not present
    fi
    
    # Check if the file contains the marker from AGENTS.md
    if grep -q "^# Universal Dual-Workflow Agent System$" "$target_file" 2>/dev/null; then
        return 0  # Content already exists
    fi
    
    return 1  # Content doesn't exist
}

# Function to add TOOL_USAGE.md content to target directory
add_tool_usage_docs() {
    local target_dir="$PROJECT_DIR/docs"
    local target_file="$target_dir/TOOL_USAGE.md"
    local source_file="$ADD_MCPS_DIR/TOOL_USAGE.md"

    if tool_usage_content_exists "$target_file"; then
        log_info "TOOL_USAGE.md content already exists in project, skipping..."
        return 0
    fi

    if [[ ! -f "$source_file" ]]; then
        log_warning "Source TOOL_USAGE.md not found at $source_file, skipping..."
        log_warning "Run install.sh to set up the add-mcps system"
        return 0  # Non-fatal warning
    fi

    # Create docs directory if it doesn't exist
    mkdir -p "$target_dir"

    log_info "Adding TOOL_USAGE.md to project docs/..."

    # If target file exists, append a separator and then the content
    if [[ -f "$target_file" ]]; then
        echo "" >> "$target_file"
        echo "---" >> "$target_file"
        echo "" >> "$target_file"
        echo "<!-- Content below added by add-mcps script -->" >> "$target_file"
        echo "" >> "$target_file"
        cat "$source_file" >> "$target_file"
        log_success "Appended TOOL_USAGE.md content to existing file"
    else
        # Create new file with content
        cp "$source_file" "$target_file"
        log_success "Created docs/TOOL_USAGE.md in project"
    fi

    return 0
}

# Function to copy AGENTS.md if it doesn't exist or doesn't have correct content
add_agents_doc() {
    local target_file="$PROJECT_DIR/AGENTS.md"
    local source_file="$ADD_MCPS_DIR/AGENTS.md"
    
    if agents_content_exists "$target_file"; then
        log_info "AGENTS.md content already exists in project, skipping..."
        return 0
    fi
    
    if [[ ! -f "$source_file" ]]; then
        log_warning "Source AGENTS.md not found at $source_file, skipping..."
        log_warning "Run install.sh to set up the add-mcps system"
        return 0  # Non-fatal warning
    fi
    
    log_info "Copying AGENTS.md to project..."
    cp "$source_file" "$target_file"
    log_success "Copied AGENTS.md to project"
    
    return 0
}

# Function to copy agent files if they don't exist
add_agent_files() {
    local source_agents_dir="$ADD_MCPS_DIR/agents"
    local target_agents_dir="$PROJECT_DIR/.claude/agents"
    
    if [[ ! -d "$source_agents_dir" ]]; then
        log_warning "Source agents directory not found at $source_agents_dir, skipping..."
        log_warning "Run install.sh to set up the add-mcps system"
        return 0  # Non-fatal warning
    fi
    
    # Create target agents directory if it doesn't exist
    mkdir -p "$target_agents_dir"
    
    log_info "Copying agent files to project..."
    local copied_count=0
    local skipped_count=0
    
    # Copy each agent file if it doesn't already exist
    for agent_file in "$source_agents_dir"/*.md; do
        if [[ ! -f "$agent_file" ]]; then
            continue
        fi
        
        local agent_name=$(basename "$agent_file")
        local target_agent_file="$target_agents_dir/$agent_name"
        
        if [[ -f "$target_agent_file" ]]; then
            log_info "  $agent_name already exists, skipping..."
            ((skipped_count++))
        else
            cp "$agent_file" "$target_agent_file"
            log_info "  Copied $agent_name"
            ((copied_count++))
        fi
    done
    
    if [[ $copied_count -gt 0 ]]; then
        log_success "Copied $copied_count agent file(s) to project"
    fi
    
    if [[ $skipped_count -gt 0 ]]; then
        log_info "Skipped $skipped_count agent file(s) (already exist)"
    fi
    
    return 0
}

# Install Exa MCP Server
if should_install_server "exa"; then
    echo "===================================="
    echo "Installing Exa MCP Server..."
    echo "===================================="
    
    # Use default API key if not set
    if [[ -z "$EXA_API_KEY" ]]; then
        EXA_API_KEY="2ea2c6f8-2fb7-4ff7-bb2d-16a7356bd248"
        log_info "Using default Exa API key"
    else
        log_info "Using custom Exa API key from environment"
    fi
    
    add_mcp_server "exa" "/Users/pentester/.claude/local/claude mcp add exa --transport stdio -e EXA_API_KEY=\"$EXA_API_KEY\" -- npx -y exa-mcp-server --tools=web_search_exa,research_paper_search,company_research,crawling,competitor_finder,linkedin_search,wikipedia_search_exa,github_search"
    echo ""
fi

# Install Sequential Thinking MCP Server
if should_install_server "sequential-thinking"; then
    echo "===================================="
    echo "Installing Sequential Thinking MCP Server..."
    echo "===================================="
    add_mcp_server "sequential-thinking" "/Users/pentester/.claude/local/claude mcp add sequential-thinking -- npx -y @modelcontextprotocol/server-sequential-thinking"
    echo ""
fi

# Install Serena MCP Server
if should_install_server "serena"; then
    echo "===================================="
    echo "Installing Serena MCP Server..."
    echo "===================================="
    
    # Check if uvx is available
    if ! command -v uvx &> /dev/null; then
        log_warning "uvx command not found. Serena requires Python and uvx to be installed."
        log_info "To install uvx, run: pip install uv"
        log_warning "Skipping Serena installation..."
    else
        # First, index the project with Serena
        log_info "Indexing project with Serena..."
        uvx --from git+https://github.com/oraios/serena serena project index || {
            log_warning "Project indexing failed. Continuing with installation..."
        }
        
        add_mcp_server "serena" "/Users/pentester/.claude/local/claude mcp add serena -- uvx --from git+https://github.com/oraios/serena serena start-mcp-server --context ide-assistant --project \"$PROJECT_DIR\""
    fi
    echo ""
fi

# Install Playwright MCP Server
if should_install_server "playwright"; then
    echo "===================================="
    echo "Installing Playwright MCP Server..."
    echo "===================================="
    
    # Install Playwright dependencies and browsers
    log_info "Installing Playwright dependencies..."
    npx playwright install-deps > /dev/null 2>&1 || log_warning "Some Playwright system dependencies may be missing"
    
    log_info "Installing Playwright browsers..."
    npx playwright install > /dev/null 2>&1 || {
        log_warning "Could not install all Playwright browsers. Some features may not work."
    }
    
    add_mcp_server "playwright" "/Users/pentester/.claude/local/claude mcp add playwright -- npx -y @playwright/mcp@latest"
    echo ""
fi

# Install Context7 MCP Server
if should_install_server "context7"; then
    echo "===================================="
    echo "Installing Context7 MCP Server..."
    echo "===================================="

    add_mcp_server "context7" "/Users/pentester/.claude/local/claude mcp add context7 -- npx -y @upstash/context7-mcp@latest"
    echo ""
fi

# Install Server-Memory MCP Server
if should_install_server "server-memory"; then
    echo "===================================="
    echo "Installing Server-Memory MCP Server..."
    echo "===================================="

    add_mcp_server "server-memory" "/Users/pentester/.claude/local/claude mcp add server-memory -- npx -y @modelcontextprotocol/server-memory"
    echo ""
fi

# Copy documentation and agents (if flags are specified)
if [[ "$ADD_AGENTS" == true ]] || [[ "$ADD_TOOLS" == true ]]; then
    echo "===================================="
    echo "Copying Documentation and Agents..."
    echo "===================================="
    echo ""

    # Add TOOL_USAGE.md if --add-tools is specified
    if [[ "$ADD_TOOLS" == true ]]; then
        add_tool_usage_docs
        echo ""
    fi

    # Add agents and AGENTS.md if --add-agents is specified
    if [[ "$ADD_AGENTS" == true ]]; then
        add_agents_doc
        echo ""

        add_agent_files
        echo ""
    fi
fi

# Summary
echo "===================================="
log_success "MCP Server Installation Complete!"
echo "===================================="
echo ""
log_info "Installed servers:"
for server in "${!MCP_SERVERS[@]}"; do
    if should_install_server "$server"; then
        echo -e "  ${GREEN}âœ“${NC} $server"
    else
        echo -e "  ${YELLOW}âœ—${NC} $server (skipped)"
    fi
done
echo ""
log_info "Configuration saved to: $SETTINGS_FILE"
echo ""
log_info "Testing server connections..."
if /Users/pentester/.claude/local/claude mcp list > /dev/null 2>&1; then
    log_success "All configured servers are accessible!"
else
    log_warning "Some servers may not be connecting properly. Check the output above for errors."
fi
echo ""
# Show documentation and agents status
if [[ "$ADD_AGENTS" == true ]] || [[ "$ADD_TOOLS" == true ]]; then
    log_info "Documentation and agents:"

    if [[ "$ADD_TOOLS" == true ]]; then
        if [[ -f "$PROJECT_DIR/docs/TOOL_USAGE.md" ]]; then
            echo -e "  ${GREEN}âœ“${NC} docs/TOOL_USAGE.md"
        fi
    fi

    if [[ "$ADD_AGENTS" == true ]]; then
        if [[ -f "$PROJECT_DIR/AGENTS.md" ]]; then
            echo -e "  ${GREEN}âœ“${NC} AGENTS.md"
        fi
        if [[ -d "$PROJECT_DIR/.claude/agents" ]]; then
            agent_count=$(find "$PROJECT_DIR/.claude/agents" -name "*.md" 2>/dev/null | wc -l | tr -d ' ')
            if [[ $agent_count -gt 0 ]]; then
                echo -e "  ${GREEN}âœ“${NC} $agent_count agent file(s)"
            fi
        fi
    fi
    echo ""
fi
echo -e "${BLUE}Next steps:${NC}"
echo "  1. Restart Claude Code if it's running"
echo "  2. The servers will be available in this project directory"
echo ""
echo -e "${BLUE}Notes:${NC}"
echo "  â€¢ Exa server uses the provided API key"
echo "  â€¢ Run '$0 --diagnose' to troubleshoot issues"
echo "  â€¢ Set EXA_API_KEY environment variable for custom API key"
echo "  â€¢ Use --force to reinstall servers that are already installed"
if [[ "$ADD_AGENTS" == true ]] || [[ "$ADD_TOOLS" == true ]]; then
    echo "  â€¢ Documentation and agents have been copied to this project"
fi
